### Do we need features fusion across multiple pathological foundation models for downstream tasks fine-tuning?

#### Patch-level pathological foundation models

- [CHIEF](https://github.com/hms-dbmi/CHIEF) is pretrained on 60,530 WSIs spanning 19 anatomical sites from 14 cohorts[1].

- [GigaPath](https://github.com/prov-gigapath/prov-gigapath) is pretrained on 171,189 WSIs across 31 major tissue types from 28 cancer centers[2].

- [UNI](https://github.com/mahmoodlab/UNI) is pretrained on 100,426 WSIs covering 20 major tissue types from two hospitals and the Genotype-Tissue Expression (GTEx) consortium[3].

#### WSI-level pathological foundation models

- [TITAN](https://github.com/mahmoodlab/TITAN) is a multimodal foundation model trained on 335,645 WSIs using visual self-supervised learning and vision-language alignment with pathology reports, along with 423,122 synthetic captions generated by a multimodal AI copilot[4].

- [PRISM](https://huggingface.co/paige-ai/Prism) is pretrained on 587,000 WSIs with 195,000 clinical text reports[5].


#### I. CLAM-based patch-level features fusion for tumor subtyping
In **./1.CLAM_patch_subtyping** directory
For tumor subtyping prediction on WSIs from the TCGA dataset, we utilized three patch-level foundation models to extract patch features, followed by downstream fine-tuning using the [CLAM](https://github.com/mahmoodlab/CLAM) framework[6]. 

The WSI features of TCGA-BRCA and NSCLC extracted by these three foundation models are stored in folders ​**​FEATURES_DIRECTORY_CHIEF​**​, **​​FEATURES_DIRECTORY_gigapath​**​, and **​​FEATURES_DIRECTORY_UNI**​​ under directories **./CLAM_feature/BRCA** and **./CLAM_feature/NSCLC**, respectively. We run the following script to concatenate the features from these three models and save them in the ​**​FEATURES_CHIEF_gigapath_UNI​**​ folder.

```bash
python BRCA_feature_integration.py
python NSCLC_feature_integration.py
```
For downstream training with individual foundation model features, we input the extracted CHIEF, GigaPath, and UNI feature vectors into the CLAM framework. 
we randomly split the data 10 times, with 10% as the validation set, 10% as the test set, and the remaining 80% as the training set. 

##### Single foundation model
In **./1.CLAM_patch_subtyping/single_FM** directory

- CHIEF
- TCGA-BRCA (100% data)
```bash
python main_BRCA_subtype.py --drop_out --early_stopping  \
  --k 10 --k_start 0 --k_end 10 \
  --label_frac 1 --exp_code BRCA_CHIEF_train_100 \
  --split_dir "../CLAM_feature/subtype_list/tcga_brca/p100" \
  --weighted_sample --bag_loss ce \
  --inst_loss svm --task task_2_tumor_subtyping --model_type clam_sb \
  --log_data --subtyping \
  --data_root_dir "../CLAM_feature/BRCA/FEATURES_DIRECTORY_CHIEF" \
  --seed 123 --lr 2e-4 \
  --max_epochs 20 \
  --patience 10 \
  --encoding_size 768 \
  --csv_path "../CLAM_feature/subtype_list/tcga_brca_subset.csv"

python eval_BRCA_subtype.py --drop_out \
  --k 10 \
  --save_exp_code BRCA_CHIEF_eval_100 --models_exp_code BRCA_CHIEF_train_100_s123 \
  --splits_dir "../CLAM_feature/subtype_list/tcga_brca/p100" \
  --task task_2_tumor_subtyping --model_type clam_sb \
  --data_root_dir "../CLAM_feature/BRCA/FEATURES_DIRECTORY_CHIEF" \
  --encoding_size 768 \
  --csv_path "../CLAM_feature/subtype_list/tcga_brca_subset.csv"
```

- TCGA-NSCLC (100% data)
```bash
python main_NSCLC_subtype.py --drop_out --early_stopping  \
  --k 10 --k_start 0 --k_end 10 \
  --label_frac 1 --exp_code NSCLC_CHIEF_train_100 \
  --split_dir "../CLAM_feature/subtype_list/tcga_lung/p100" \
  --weighted_sample --bag_loss ce \
  --inst_loss svm --task task_2_tumor_subtyping --model_type clam_sb \
  --log_data --subtyping \
  --data_root_dir "../CLAM_feature/NSCLC/FEATURES_DIRECTORY_CHIEF" \
  --seed 123 --lr 2e-4 \
  --max_epochs 20 \
  --patience 10 \
  --encoding_size 768 \
  --csv_path "../CLAM_feature/subtype_list/tcga_lung_subset.csv"

python eval_NSCLC_subtype.py --drop_out  \
  --k 10 \
  --save_exp_code NSCLC_CHIEF_eval_100 --models_exp_code NSCLC_CHIEF_train_100_s123 \
  --splits_dir "../CLAM_feature/subtype_list/tcga_lung/p100" \
  --task task_2_tumor_subtyping --model_type clam_sb \
  --data_root_dir "../CLAM_feature/NSCLC/FEATURES_DIRECTORY_CHIEF" \
  --encoding_size 768 \
  --csv_path "../CLAM_feature/subtype_list/tcga_lung_subset.csv"
```

To simulate a more data-limited scenario, the dataset was downsampled to 25%, followed by an 8:1:1 split. 
In this scenario, simply adjust the **--splits_dir parameter** in the above script from **​​p100**​​ to **​​p25**​​.

For ​​GigaPath​​ and ​​UNI​​, we only need to adjust the **--data_root_dir** in the above script to point to the respective folders containing the features extracted by each model.

##### Concatenation
In **./1.CLAM_patch_subtyping/concat_FM** directory

- TCGA-BRCA (100% data)

```bash
python main_multi_BRCA_subtype.py --drop_out --early_stopping  \
  --k 10 --k_start 0 --k_end 10 \
  --label_frac 1 --exp_code multi_BRCA_CGU_100 \
  --split_dir "../CLAM_feature/subtype_list/tcga_brca/p100" \
  --weighted_sample --bag_loss ce \
  --inst_loss svm --task task_2_tumor_subtyping --model_type clam_sb \
  --log_data --subtyping \
  --data_root_dir "../CLAM_feature/BRCA/FEATURES_CHIEF_gigapath_UNI" \
  --seed 123 --lr 2e-4 \
  --max_epochs 20 \
  --patience 10 \
  --encoding_size 3328 \
  --csv_path "../CLAM_feature/subtype_list/tcga_brca_subset.csv" \
  --features_list "FEATURES_DIRECTORY_CHIEF" "FEATURES_DIRECTORY_gigapath" "FEATURES_DIRECTORY_UNI"

python eval_multi_BRCA_subtype.py --drop_out  \
  --k 10 \
  --save_exp_code multi_BRCA_CGU_100_eval --models_exp_code multi_BRCA_CGU_100_s123 \
  --splits_dir "../CLAM_feature/subtype_list/tcga_brca/p100" \
  --task task_2_tumor_subtyping --model_type clam_sb \
  --data_root_dir "../CLAM_feature/BRCA/FEATURES_CHIEF_gigapath_UNI" \
  --encoding_size 3328 \
  --csv_path "../CLAM_feature/subtype_list/tcga_brca_subset.csv" \
  --features_list "FEATURES_DIRECTORY_CHIEF" "FEATURES_DIRECTORY_gigapath" "FEATURES_DIRECTORY_UNI"
```
- TCGA-NSCLC (100% data)

```bash
python main_multi_NSCLC_subtype.py --drop_out --early_stopping  \
  --k 10 --k_start 0 --k_end 10 \
  --label_frac 1 --exp_code multi_NSCLC_CGU_100 \
  --split_dir "../CLAM_feature/subtype_list/tcga_lung/p100" \
  --weighted_sample --bag_loss ce \
  --inst_loss svm --task task_2_tumor_subtyping --model_type clam_sb \
  --log_data --subtyping \
  --data_root_dir "../CLAM_feature/NSCLC/FEATURES_CHIEF_gigapath_UNI" \
  --seed 123 --lr 2e-4 \
  --max_epochs 20 \
  --patience 10 \
  --encoding_size 3328 \
  --csv_path "..CLAM_feature/subtype_list/tcga_lung_subset.csv" \
  --features_list "FEATURES_DIRECTORY_CHIEF" "FEATURES_DIRECTORY_gigapath" "FEATURES_DIRECTORY_UNI"

python eval_multi_NSCLC_subtype.py --drop_out  \
  --k 10 \
  --save_exp_code multi_NSCLC_CGU_100_eval --models_exp_code multi_NSCLC_CGU_100_s123 \
  --splits_dir "../CLAM_feature/subtype_list/tcga_lung/p100" \
  --task task_2_tumor_subtyping --model_type clam_sb \
  --data_root_dir "../CLAM_feature/NSCLC/FEATURES_CHIEF_gigapath_UNI" \
  --encoding_size 3328 \
  --csv_path "../CLAM_feature/subtype_list/tcga_lung_subset.csv" \
  --features_list "FEATURES_DIRECTORY_CHIEF" "FEATURES_DIRECTORY_gigapath" "FEATURES_DIRECTORY_UNI"
```

##### Self-attention
In **./1.CLAM_patch_subtyping/self_attention_FM** directory

- TCGA-BRCA (100% data)
```bash
python main_ca_BRCA_subtype.py --drop_out --early_stopping  \
  --k 10 --k_start 0 --k_end 10 \
  --label_frac 1 --exp_code ca_BRCA_CGU_100 \
  --split_dir "../CLAM_feature/subtype_list/tcga_brca/p100" \
  --weighted_sample --bag_loss ce \
  --inst_loss svm --task task_2_tumor_subtyping --model_type clam_sb \
  --log_data --subtyping \
  --data_root_dir "../CLAM_feature/BRCA/FEATURES_CHIEF_gigapath_UNI" \
  --seed 123 --lr 2e-4 \
  --max_epochs 20 \
  --patience 10 \
  --encoding_size 3328 \
  --csv_path "../CLAM_feature/subtype_list/tcga_brca_subset.csv" \
  --features_list "FEATURES_DIRECTORY_CHIEF" "FEATURES_DIRECTORY_gigapath" "FEATURES_DIRECTORY_UNI"

python eval_ca_BRCA_subtype.py --drop_out  \
  --k 10 \
  --save_exp_code ca_BRCA_CGU_100_eval --models_exp_code ca_BRCA_CGU_100_s123 \
  --splits_dir "../CLAM_feature/subtype_list/tcga_brca/p100" \
  --task task_2_tumor_subtyping --model_type clam_sb \
  --data_root_dir "../CLAM_feature/BRCA/FEATURES_CHIEF_gigapath_UNI" \
  --encoding_size 3328 \
  --csv_path "../CLAM_feature/subtype_list/tcga_brca_subset.csv" \
  --features_list "FEATURES_DIRECTORY_CHIEF" "FEATURES_DIRECTORY_gigapath" "FEATURES_DIRECTORY_UNI"
```

- TCGA-NSCLC (100% data)
```bash
python main_ca_NSCLC_subtype.py --drop_out --early_stopping  \
  --k 10 --k_start 0 --k_end 10 \
  --label_frac 1 --exp_code ca_NSCLC_CGU_100 \
  --split_dir "../CLAM_feature/subtype_list/tcga_lung/p100" \
  --weighted_sample --bag_loss ce \
  --inst_loss svm --task task_2_tumor_subtyping --model_type clam_sb \
  --log_data --subtyping \
  --data_root_dir "../CLAM_feature/NSCLC/FEATURES_CHIEF_gigapath_UNI" \
  --seed 123 --lr 2e-4 \
  --max_epochs 20 \
  --patience 10 \
  --encoding_size 3328 \
  --csv_path "../CLAM_feature/subtype_list/tcga_lung_subset.csv" \
  --features_list "FEATURES_DIRECTORY_CHIEF" "FEATURES_DIRECTORY_gigapath" "FEATURES_DIRECTORY_UNI"

python eval_ca_NSCLC_subtype.py --drop_out  \
  --k 10 \
  --save_exp_code ca_NSCLC_CGU_100_eval --models_exp_code ca_NSCLC_CGU_100_s123 \
  --splits_dir "../CLAM_feature/subtype_list/tcga_lung/p25" \
  --task task_2_tumor_subtyping --model_type clam_sb \
  --data_root_dir "../CLAM_feature/NSCLC/FEATURES_CHIEF_gigapath_UNI" \
  --encoding_size 3328 \
  --csv_path "../CLAM_feature/subtype_list/tcga_lung_subset.csv" \
  --features_list "FEATURES_DIRECTORY_CHIEF" "FEATURES_DIRECTORY_gigapath" "FEATURES_DIRECTORY_UNI"
```

#### II. WSI-level features fusion for tumor subtyping
In **./2.WSI_subtyping** directory

For foundation models capable of processing entire WSIs, we directly obtain WSI-level feature representations for downstream fine-tuning. Model performance is evaluated via five-fold cross-validation, repeated 10 times with different random splits. The dataset splitting results are saved in **./2.WSI_subtyping/subtyping_label** directory.

 WSI features are extracted using TITAN and PRISM, yielding feature dimensions of 768 and 1280. The extracted features for TCGA-BRCA and TCGA-NSCLC are stored in the **​​FEATURES_DIRECTORY_PRISM_WSI_features**​​ and **​​FEATURES_DIRECTORY_TITAN_WSI_features**​​ folders under ​**​./2.WSI_subtyping/embedding_features/BRCA**​​ and **​​./2.WSI_subtyping/embedding_features/NSCLC​**​, respectively. Each WSI's features are saved as a separate ​​.pt​​ file. 

##### Single foundation model

- TITAN
- TCGA-BRCA

```bash
python TCGA_subtyping_single_main.py \
    --feature_type 'TITAN' \
    --cancer_type 'BRCA' \
    --batch_size 128 \
    --epochs_num 100 \
    --n_cycles 1 \
    --lr 5e-4 \
    --min_lr 1e-5 \
    --output_root './results' \
    --version 'v1' \
    --alpha_values 0.8
```
- TCGA-NSCLC
```bash
python TCGA_subtyping_single_main.py \
    --feature_type 'TITAN' \
    --cancer_type 'NSCLC' \
    --batch_size 128 \
    --epochs_num 100 \
    --n_cycles 1 \
    --lr 5e-4 \
    --min_lr 1e-5 \
    --output_root './results' \
    --version 'v1' \
    --alpha_values 0.5
```

For PRISM model​​, we only need to adjust the **--feature_type** to 'PRISM', and all other parameters are kept the same.

##### Concatenation
- TCGA-BRCA

```bash
python TCGA_subtyping_concat_main.py \
    --feature_types 'TITAN' 'PRISM' \
    --feature_num 2048 \
    --cancer_type 'BRCA' \
    --batch_size 128 \
    --epochs_num 100 \
    --n_cycles 1 \
    --lr 5e-4 \
    --min_lr 1e-5 \
    --output_root './results' \
    --version 'v1' \
    --alpha_values 0.8
```

- TCGA-NSCLC

```bash
python TCGA_subtyping_concat_main.py \
    --feature_types 'TITAN' 'PRISM' \
    --feature_num 2048 \
    --cancer_type 'NSCLC' \
    --batch_size 128 \
    --epochs_num 100 \
    --n_cycles 1 \
    --lr 5e-4 \
    --min_lr 1e-5 \
    --output_root './results' \
    --version 'v1' \
    --alpha_values 0.5
```

##### Self-attention
- TCGA-BRCA
```bash
python TCGA_subtyping_self_attention_main.py \
    --feature_types 'TITAN' 'PRISM' \
    --feature_num 2048 \
    --cancer_type 'BRCA' \
    --batch_size 128 \
    --epochs_num 100 \
    --n_cycles 1 \
    --lr 5e-4 \
    --min_lr 1e-5 \
    --output_root './results' \
    --version 'v1' \
    --alpha_values 0.8 \
    --embed_dim 1024 \
    --num_heads 8
```

- TCGA-NSCLC
```bash
python TCGA_subtyping_self_attention_main.py \
    --feature_types 'TITAN' 'PRISM' \
    --feature_num 2048 \
    --cancer_type 'NSCLC' \
    --batch_size 128 \
    --epochs_num 100 \
    --n_cycles 1 \
    --lr 5e-4 \
    --min_lr 1e-5 \
    --output_root './results' \
    --version 'v1' \
    --alpha_values 0.5 \
    --embed_dim 1024 \
    --num_heads 8
```

#### III. Multi-class classification for patches in the HE-CRC-100K dataset 
In **./3.CRC100k_multi_class** directory

The [HE-CRC-100K](https://zenodo.org/records/1214456) dataset contains patches from 9 distinct labels. The dataset has a predefined train/test split, with the corresponding indices and encoded labels stored in **​​./3.CRC100k_multi_class/NCT-CRC-HE-100k/split_index**​​.  Patch-level features are extracted using three patch-level foundation models, and these features are stored in the ​**​CHIEF**​​, **​​GigaPath**​​, and ​**​UNI**​​ folders under ​**​./3.CRC100k_multi_class/NCT-CRC-HE-100k​**​.

##### Single foundation model
To ensure robustness, each experiment is repeated ten times, and the mean and standard deviation of performance metrics are reported. 

- CHIEF

```bash
python CRC100k_linear_probe_main_single.py \
    --feature_type 'CHIEF' \
    --rep_num 10 \
    --embed_dim 768 \
    --batch_size 512 \
    --train_iters 10000 \
    --n_cycles 5 \
    --lr 1e-4 \
    --min_lr 1e-6 \
    --eval_interval 500 \
    --output_root './results/CHIEF_rep10'
```

- GigaPath

```bash
python CRC100k_linear_probe_main_single.py \
    --feature_type 'GigaPath' \
    --rep_num 10 \
    --embed_dim 1536 \
    --batch_size 512 \
    --train_iters 10000 \
    --n_cycles 5 \
    --lr 1e-4 \
    --min_lr 1e-6 \
    --eval_interval 500 \
    --output_root './results/GigaPath_rep10'
```

- UNI

```bash
python CRC100k_linear_probe_main_single.py \
    --feature_type 'UNI' \
    --rep_num 10 \
    --embed_dim 1024 \
    --batch_size 512 \
    --train_iters 10000 \
    --n_cycles 5 \
    --lr 1e-4 \
    --min_lr 1e-6 \
    --eval_interval 500 \
    --output_root './results/UNI_rep10'
```

##### Concatenation
```bash
python CRC100k_linear_probe_main_concat.py \
    --features_list 'CHIEF' 'GigaPath' 'UNI'\
    --rep_num 10 \
    --embed_dim 3328 \
    --batch_size 512 \
    --train_iters 10000 \
    --n_cycles 5 \
    --lr 1e-4 \
    --min_lr 1e-6 \
    --eval_interval 500 \
    --output_root './results/concat_rep10'
```

##### Self-attention
```bash
python CRC100k_linear_probe_main_cross_attention.py \
    --features_list 'CHIEF' 'GigaPath' 'UNI'\
    --rep_num 10 \
    --embed_dim 1024 \
    --num_heads 8 \
    --encoding_size 3328 \
    --batch_size 512 \
    --train_iters 10000 \
    --n_cycles 5 \
    --lr 1e-4 \
    --min_lr 1e-6 \
    --eval_interval 500 \
    --output_root './results/self_attention_rep10'
```

#### IV. Multi-Label prediction of tumor biomarkers using WSI-Level representations
In **./4.WSI_multi_label_prediction** directory

All data were partitioned using five-fold cross-validation, repeated ten times to generate ten distinct data splits. The dataset division results are stored in Folder **./4.WSI_multi_label_prediction/splits_five_fold**. Biomarker-related information is saved in Folder **./4.WSI_multi_label_prediction/biomarker_info**.

The extracted features for TCGA-BRCA and TCGA-CRC are stored in the **​​FEATURES_DIRECTORY_PRISM_WSI_features**​​ and **​​FEATURES_DIRECTORY_TITAN_WSI_features**​​ folders under ​**​./4.WSI_multi_label_prediction/embedding_features/BRCA**​​ and **​​./4.WSI_multi_label_prediction/embedding_features/CRC​**​, respectively. Each WSI's features are saved as a separate ​​.pt​​ file. 

##### Single foundation model
- TITAN
- TCGA-BRCA

```bash
python TCGA_mutation_single_main.py \
    --feature_type 'TITAN' \
    --cancer_type 'BRCA' \
    --batch_size 256 \
    --epochs_num 100 \
    --n_cycles 1 \
    --lr 1e-4 \
    --min_lr 1e-6 \
    --output_root './results' \
    --version 'TITAN_focal_v1' \
    --predict_genes 'TP53' 'PIK3CA' 'CDH1' \
    --alpha_values 0.6 0.6 0.9
```

- TCGA-CRC
```bash
python TCGA_mutation_single_main.py \
    --feature_type 'TITAN' \
    --cancer_type 'CRC' \
    --batch_size 256 \
    --epochs_num 100 \
    --n_cycles 1 \
    --lr 1e-4 \
    --min_lr 1e-6 \
    --output_root './results' \
    --version 'TITAN_focal_v1' \
    --predict_genes 'RAS' 'BRAF' 'MSI'\
    --alpha_values 0.5 0.8 0.8
```

For PRISM model​​, we only need to adjust the **--feature_type** to 'PRISM' and the **--version** to corresponding name, and all other parameters are kept the same.

##### Concatenation
- TCGA-BRCA
```bash
python TCGA_mutation_concat_main.py \
    --feature_types 'TITAN' 'PRISM' \
    --feature_num 2048 \
    --cancer_type 'BRCA' \
    --batch_size 256 \
    --epochs_num 100 \
    --n_cycles 1 \
    --lr 1e-4 \
    --min_lr 1e-6 \
    --output_root './results' \
    --version 'concat_focal_v1' \
    --predict_genes 'TP53' 'PIK3CA' 'CDH1' \
    --alpha_values 0.6 0.6 0.9
```

- TCGA-CRC
```bash
python TCGA_mutation_concat_main.py \
    --feature_types 'TITAN' 'PRISM' \
    --feature_num 2048 \
    --cancer_type 'CRC' \
    --batch_size 256 \
    --epochs_num 100 \
    --n_cycles 1 \
    --lr 1e-4 \
    --min_lr 1e-6 \
    --output_root './results' \
    --version 'concat_focal_v1' \
    --predict_genes 'RAS' 'BRAF' 'MSI'\
    --alpha_values 0.5 0.8 0.8
```

##### Self-attention
- TCGA-BRCA
```bash
python TCGA_mutation_self_attention_main.py \
    --feature_types 'TITAN' 'PRISM' \
    --feature_num 2048 \
    --cancer_type 'BRCA' \
    --batch_size 256 \
    --epochs_num 100 \
    --n_cycles 1 \
    --lr 1e-4 \
    --min_lr 1e-6 \
    --output_root './results' \
    --version 'CA_focal_v1' \
    --predict_genes 'TP53' 'PIK3CA' 'CDH1' \
    --alpha_values 0.6 0.6 0.9 \
    --embed_dim 1024 \
    --num_heads 8
```

- TCGA-CRC
```bash
python TCGA_mutation_self_attention_main.py \
    --feature_types 'TITAN' 'PRISM' \
    --feature_num 2048 \
    --cancer_type 'CRC' \
    --batch_size 256 \
    --epochs_num 100 \
    --n_cycles 1 \
    --lr 1e-4 \
    --min_lr 1e-6 \
    --output_root './results' \
    --version 'self_attention_focal_v1' \
    --predict_genes 'RAS' 'BRAF' 'MSI'\
    --alpha_values 0.5 0.8 0.8 \
    --embed_dim 1024 \
    --num_heads 8
```


#### Reference
[1] Wang, X., et al., A pathology foundation model for cancer diagnosis and prognosis prediction. Nature, 2024. 634(8035): p. 970-978.

[2] Xu, H., et al., A whole-slide foundation model for digital pathology from real-world data. Nature, 2024. 630(8015): p. 181-188.

[3] Chen, R.J., et al., Towards a general-purpose foundation model for computational pathology. Nature Medicine, 2024. 30(3): p. 850-862.

[4] Ding, T., et al., Multimodal whole slide foundation model for pathology. arXiv preprint arXiv:2411.19666, 2024.

[5] Shaikovski, G., et al., Prism: A multi-modal generative foundation model for slide-level histopathology. arXiv preprint arXiv:2405.10254, 2024.

[6] Lu, M.Y., et al., Data-efficient and weakly supervised computational pathology on whole-slide images. Nature biomedical engineering, 2021. 5(6): p. 555-570.